<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>ElectricalFlo 3D — Shop</title>
  <meta name="description" content="ElectricalFlo 3D — 3D printed gear and custom orders. Add items to cart, then email your order for PayPal, Venmo, or Zelle payment info." />

  <!-- Canonical -->
  <link rel="canonical" href="https://electricalflo.com/" />

  <!-- OpenGraph (link previews on iMessage / FB / Discord / etc.) -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="ElectricalFlo 3D — Shop" />
  <meta property="og:description" content="3D printed gear • custom orders welcome. Add items to cart, then email your order for payment info." />
  <meta property="og:url" content="https://electricalflo.com/" />
  <!-- Create this image: 1200x630, place at /images/social-preview.jpg -->
  <meta property="og:image" content="https://electricalflo.com/images/social-preview.jpg" />

  <!-- Twitter / X -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="ElectricalFlo 3D — Shop" />
  <meta name="twitter:description" content="3D printed gear • custom orders welcome. Add items to cart, then email your order for payment info." />
  <meta name="twitter:image" content="https://electricalflo.com/images/social-preview.jpg" />

  <link rel="stylesheet" href="style.css?v=20260130-4" />
</head>
<body>

<header class="header">
  <div class="brandWrap">
    <img src="images/logo.png" alt="ElectricalFlo 3D Logo" class="logo" />
    <div class="brand">
      <h1>ElectricalFlo 3D</h1>
      <p>3D printed gear • custom orders welcome</p>
    </div>
  </div>

  <button class="cartBtn" id="openCartBtn" type="button">
    Cart <span class="pill" id="cartCount">0</span>
  </button>
</header>

<main class="wrap">

  <!-- Recently Viewed -->
  <section id="recentWrap" style="display:none; margin-bottom:14px;">
    <div style="display:flex;justify-content:space-between;align-items:baseline;gap:10px;margin-bottom:10px;">
      <h2 style="margin:0;font-size:16px;">Recently viewed</h2>
      <button class="link" type="button" id="clearRecentBtn">Clear</button>
    </div>
    <section class="grid" id="recentGrid"></section>
  </section>

  <section class="toolbar">
    <input id="search" placeholder="Search items…" />
    <select id="sort">
      <option value="featured">Sort: Featured</option>
      <option value="price_asc">Price: Low → High</option>
      <option value="price_desc">Price: High → Low</option>
      <option value="name_asc">Name: A → Z</option>
    </select>
  </section>

  <section class="grid" id="grid"></section>
</main>

<!-- CART DRAWER -->
<aside class="drawer" id="drawer" aria-hidden="true">
  <div class="drawerHeader">
    <h2>Your Cart</h2>
    <button class="iconBtn" id="closeCartBtn" type="button">✕</button>
  </div>

  <div class="drawerBody" id="cartItems"></div>

  <div class="drawerFooter">
    <div class="totalRow">
      <span>Subtotal</span>
      <strong id="subtotal">$0.00</strong>
    </div>

    <label class="field">
      <span>Your name (optional)</span>
      <input id="customerName" placeholder="Your name" />
    </label>

    <label class="field">
      <span>Notes (colors, callsign, etc.)</span>
      <textarea id="orderNotes" rows="3" placeholder="Example: black PETG, callsign N2CFX, include keyring…"></textarea>
    </label>

    <label class="field">
      <span>Preferred payment method</span>
      <select id="paymentMethod">
        <option value="PayPal">PayPal</option>
        <option value="Venmo">Venmo</option>
        <option value="Zelle">Zelle</option>
      </select>
    </label>

    <label class="field checkbox">
      <input type="checkbox" id="includeShippingNow" />
      <span>Include shipping address now (optional)</span>
    </label>

    <label class="field" id="shippingWrap" style="display:none">
      <span>Shipping address</span>
      <textarea id="shippingAddress" rows="3" placeholder="Street, City, State, ZIP"></textarea>
    </label>

    <button class="primary" id="emailCheckoutBtn" type="button">
      Email Order for Payment Info
    </button>

    <div style="display:flex;gap:10px;flex-wrap:wrap;">
      <button class="ghost" id="copyOrderBtn" type="button">Copy order details</button>
      <button class="ghost" id="printOrderBtn" type="button">View / Print summary</button>
      <button class="ghost" id="csvOrderBtn" type="button">Download CSV</button>
    </div>

    <button class="ghost" id="clearCartBtn" type="button">
      Clear cart
    </button>

    <p class="fine" style="margin-top:6px;">
      No payment is taken on this site. You’ll email the order and receive payment & shipping info.
    </p>
  </div>
</aside>

<div class="backdrop" id="backdrop" hidden></div>

<script>
/* ================= CONFIG ================= */
const SITE_URL = "https://electricalflo.com";
const EMAIL_TO = "flores@n2cfx.com";

/**
 * Optional BCC
 * - Many mail clients support mailto bcc=, some ignore it.
 * - If ignored, nothing breaks — it just won’t BCC.
 */
const EMAIL_BCC = "flores@n2cfx.com"; // set "" to disable

const EMAIL_SUBJECT_PREFIX = "ElectricalFlo 3D Order";

/* ================= STATE ================= */
let PRODUCTS = [];
let cart = JSON.parse(localStorage.getItem("cart") || "{}"); // { productId: qty }
let modalState = null; // {productId, imgs, idx, title}

/* ================= HELPERS ================= */
const money = n => `$${Number(n || 0).toFixed(2)}`;

function getProductImages(p){
  if (Array.isArray(p.images) && p.images.length) return p.images;
  if (p.image) return [p.image];
  return [];
}

function cartCount(){
  return Object.values(cart).reduce((a,b)=>a+Number(b||0),0);
}

function saveCart(){
  localStorage.setItem("cart", JSON.stringify(cart));
  document.getElementById("cartCount").textContent = cartCount();
}

function addToCart(id){
  cart[id] = (cart[id] || 0) + 1;
  saveCart();
  renderCart();
  trackRecent(id);
}

function decFromCart(id){
  if (!cart[id]) return;
  cart[id] -= 1;
  if (cart[id] <= 0) delete cart[id];
  saveCart();
  renderCart();
}

function removeFromCart(id){
  delete cart[id];
  saveCart();
  renderCart();
}

function clearCart(){
  cart = {};
  saveCart();
  renderCart();
  resetOrderId();
}

/* ================= ORDER NUMBER (B) ================= */
/* Format: EF-YYYYMMDD-##### */
function pad2(n){ return String(n).padStart(2,"0"); }

function generateOrderId(){
  const d = new Date();
  const y = d.getFullYear();
  const m = pad2(d.getMonth()+1);
  const day = pad2(d.getDate());
  const rand = Math.floor(10000 + Math.random()*90000); // 5 digits
  return `EF-${y}${m}${day}-${rand}`;
}

function getOrCreateOrderId(){
  let id = localStorage.getItem("ef_order_id");
  if (!id) {
    id = generateOrderId();
    localStorage.setItem("ef_order_id", id);
  }
  return id;
}

function resetOrderId(){
  localStorage.removeItem("ef_order_id");
}

/* ================= RECENTLY VIEWED ================= */
const RECENT_KEY = "ef_recent";
const RECENT_MAX = 6;

function getRecent(){
  try{
    const arr = JSON.parse(localStorage.getItem(RECENT_KEY) || "[]");
    return Array.isArray(arr) ? arr : [];
  }catch{
    return [];
  }
}

function setRecent(arr){
  localStorage.setItem(RECENT_KEY, JSON.stringify(arr));
}

function trackRecent(productId){
  if (!productId) return;
  const arr = getRecent().filter(x => x !== productId);
  arr.unshift(productId);
  setRecent(arr.slice(0, RECENT_MAX));
  renderRecent();
}

function clearRecent(){
  localStorage.removeItem(RECENT_KEY);
  renderRecent();
}

function renderRecent(){
  const wrap = document.getElementById("recentWrap");
  const grid = document.getElementById("recentGrid");
  const ids = getRecent();
  const list = ids.map(id => PRODUCTS.find(p => p.id === id)).filter(Boolean);

  if (!list.length){
    wrap.style.display = "none";
    grid.innerHTML = "";
    return;
  }

  wrap.style.display = "block";
  grid.innerHTML = list.map(p => {
    const imgs = getProductImages(p);
    const first = imgs[0] || "";
    return `
      <article class="card">
        <div class="thumb">
          <img
            src="${first}"
            alt="${p.name || "Item"}"
            loading="lazy"
            data-action="openModal"
            data-pid="${p.id}"
            data-idx="0"
            style="cursor: zoom-in;"
          >
        </div>
        <div class="cardBody">
          <h3>${p.name || "Untitled item"}</h3>
          ${p.note ? `<div class="note">${p.note}</div>` : ""}
          <span class="price">${money(p.price)}</span>
          <button class="primary" type="button" data-action="addToCart" data-pid="${p.id}">
            Add to cart
          </button>
        </div>
      </article>
    `;
  }).join("");
}

/* ================= FILTER/SORT ================= */
function getFilteredSortedProducts(){
  const q = document.getElementById("search").value.trim().toLowerCase();
  const sort = document.getElementById("sort").value;

  let list = PRODUCTS.filter(p => {
    const hay = `${p.name||""} ${p.note||""}`.toLowerCase();
    return !q || hay.includes(q);
  });

  if (sort === "price_asc") list.sort((a,b) => (a.price||0) - (b.price||0));
  if (sort === "price_desc") list.sort((a,b) => (b.price||0) - (a.price||0));
  if (sort === "name_asc") list.sort((a,b) => (a.name||"").localeCompare(b.name||""));
  return list;
}

/* ================= PRODUCT CARD HTML ================= */
function productCardHTML(p){
  const imgs = getProductImages(p);
  const first = imgs[0] || "";

  const thumbs = imgs.length > 1 ? `
    <div class="thumbStrip" aria-label="More images">
      ${imgs.map((src, i) => `
        <button class="thumbBtn ${i===0 ? "active" : ""}"
          type="button"
          data-action="thumb"
          data-pid="${p.id}"
          data-idx="${i}"
          aria-label="Show image ${i+1}">
          <img src="${src}" alt="${p.name || "Thumbnail"}" loading="lazy">
        </button>
      `).join("")}
    </div>
  ` : "";

  return `
    <article class="card">
      <div class="thumb">
        <img
          src="${first}"
          alt="${p.name || "Item"}"
          id="img-${p.id}"
          data-action="openModal"
          data-pid="${p.id}"
          data-idx="0"
          loading="lazy"
          onerror="this.style.display='none'"
          style="cursor: zoom-in;"
        >
      </div>

      ${thumbs}

      <div class="cardBody">
        <h3>${p.name || "Untitled item"}</h3>
        ${p.note ? `<div class="note">${p.note}</div>` : ""}
        <span class="price">${money(p.price)}</span>
        <button class="primary" type="button" data-action="addToCart" data-pid="${p.id}">
          Add to cart
        </button>
      </div>
    </article>
  `;
}

/* ================= RENDER PRODUCTS ================= */
function renderProducts(){
  const grid = document.getElementById("grid");
  const list = getFilteredSortedProducts();

  if (!Array.isArray(list) || list.length === 0){
    grid.innerHTML = `<p class="empty">No products found.</p>`;
    return;
  }

  grid.innerHTML = list.map(productCardHTML).join("");
}

/* ================= CART RENDER ================= */
function renderCart(){
  const box = document.getElementById("cartItems");

  const items = Object.entries(cart).map(([id, qty]) => {
    const p = PRODUCTS.find(x => x.id === id);
    if (!p) return null;
    const q = Number(qty||0);
    const line = Number(p.price||0) * q;
    return { id, p, qty:q, line };
  }).filter(Boolean);

  if (!items.length){
    box.innerHTML = `<p class="empty">Your cart is empty.</p>`;
    document.getElementById("subtotal").textContent = money(0);
    return;
  }

  box.innerHTML = items.map(i => `
    <div class="cartRow">
      <div class="cartInfo">
        <strong>${i.p.name}</strong>
        <div class="muted">${money(i.p.price)} each • Line: ${money(i.line)}</div>

        <div class="qty" style="display:flex;gap:10px;align-items:center;margin-top:10px;">
          <button class="iconBtn" type="button" data-action="dec" data-pid="${i.id}">−</button>
          <span>${i.qty}</span>
          <button class="iconBtn" type="button" data-action="inc" data-pid="${i.id}">+</button>
          <button class="link" type="button" data-action="remove" data-pid="${i.id}" style="margin-left:auto;">Remove</button>
        </div>
      </div>
    </div>
  `).join("");

  const subtotal = items.reduce((a,b)=>a+b.line,0);
  document.getElementById("subtotal").textContent = money(subtotal);
}

/* ================= SHIPPING TOGGLE ================= */
function wireShippingToggle(){
  const cb = document.getElementById("includeShippingNow");
  const wrap = document.getElementById("shippingWrap");
  if (!cb || !wrap) return;
  cb.addEventListener("change", () => {
    wrap.style.display = cb.checked ? "block" : "none";
  });
}

/* ================= ORDER TEXT (EMAIL / COPY / PRINT / CSV) ================= */
function buildOrderItems(){
  return Object.entries(cart).map(([id, qty]) => {
    const p = PRODUCTS.find(x => x.id === id);
    if (!p) return null;
    const line = Number(p.price) * Number(qty);
    return { id, name: p.name, price: Number(p.price), qty: Number(qty), line };
  }).filter(Boolean);
}

function buildEmailBody(orderId){
  const name = (document.getElementById("customerName")?.value || "").trim();
  const notes = (document.getElementById("orderNotes")?.value || "").trim();
  const payment = document.getElementById("paymentMethod")?.value || "PayPal";

  const includeShip = document.getElementById("includeShippingNow")?.checked;
  const shipAddr = (document.getElementById("shippingAddress")?.value || "").trim();

  const items = buildOrderItems();
  const subtotal = items.reduce((a,b)=>a+b.line,0);

  const lines = [];
  lines.push(`Order Number: ${orderId}`);
  lines.push("");
  lines.push("Hi! I'd like to place an order:");
  lines.push("");

  if (name) lines.push(`Name: ${name}`);
  lines.push(`Preferred payment method: ${payment}`);
  lines.push("");

  lines.push("Items:");
  items.forEach(i => lines.push(`- ${i.name} (x${i.qty}) — $${i.line.toFixed(2)}`));

  lines.push("");
  lines.push(`Subtotal (before shipping): $${subtotal.toFixed(2)}`);
  lines.push("");

  if (notes) {
    lines.push("Notes / customization:");
    lines.push(notes);
    lines.push("");
  }

  if (includeShip && shipAddr) {
    lines.push("Shipping address:");
    lines.push(shipAddr);
    lines.push("");
  } else {
    lines.push("Shipping address: I can provide after you reply.");
    lines.push("");
  }

  lines.push("Please reply with the total (including shipping) and your payment details for the method I selected. Thanks!");
  return lines.join("\n");
}

/* ================= EMAIL (with BCC if supported) ================= */
function emailCheckout(){
  if (!Object.keys(cart).length) return;

  const orderId = getOrCreateOrderId();
  const itemCount = cartCount();

  const subject = encodeURIComponent(`${EMAIL_SUBJECT_PREFIX} ${orderId} (${itemCount} item${itemCount===1?"":"s"})`);
  const body = encodeURIComponent(buildEmailBody(orderId));

  const bccPart = EMAIL_BCC ? `&bcc=${encodeURIComponent(EMAIL_BCC)}` : "";
  const mailto = `mailto:${encodeURIComponent(EMAIL_TO)}?subject=${subject}&body=${body}${bccPart}`;

  window.location.href = mailto;

  // ✅ AUTO-RESET after action
  resetOrderId();
}

/* ================= COPY ================= */
async function copyOrderDetails(){
  if (!Object.keys(cart).length) return;

  const orderId = getOrCreateOrderId();
  const text = buildEmailBody(orderId);

  try{
    await navigator.clipboard.writeText(text);
    alert("Copied! Paste it into an email/text to send your order.");
  }catch{
    const ta = document.createElement("textarea");
    ta.value = text;
    ta.style.position = "absolute";
    ta.style.left = "-9999px";
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    document.body.removeChild(ta);
    alert("Copied! Paste it into an email/text to send your order.");
  }

  // ✅ AUTO-RESET after action
  resetOrderId();
}

/* ================= PRINTABLE SUMMARY ================= */
function openPrintSummary(){
  if (!Object.keys(cart).length) return;

  const orderId = getOrCreateOrderId();
  const name = (document.getElementById("customerName")?.value || "").trim();
  const notes = (document.getElementById("orderNotes")?.value || "").trim();
  const payment = document.getElementById("paymentMethod")?.value || "PayPal";
  const includeShip = document.getElementById("includeShippingNow")?.checked;
  const shipAddr = (document.getElementById("shippingAddress")?.value || "").trim();

  const items = buildOrderItems();
  const subtotal = items.reduce((a,b)=>a+b.line,0);

  const w = window.open("", "_blank", "noopener,noreferrer");
  if (!w) return;

  const rows = items.map(i => `
    <tr>
      <td style="padding:8px;border-bottom:1px solid #ddd;">${escapeHTML(i.name)}</td>
      <td style="padding:8px;border-bottom:1px solid #ddd;text-align:center;">${i.qty}</td>
      <td style="padding:8px;border-bottom:1px solid #ddd;text-align:right;">$${i.price.toFixed(2)}</td>
      <td style="padding:8px;border-bottom:1px solid #ddd;text-align:right;">$${i.line.toFixed(2)}</td>
    </tr>
  `).join("");

  w.document.write(`
    <!doctype html>
    <html>
      <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Order ${orderId}</title>
        <style>
          body{ font-family: system-ui,-apple-system,Segoe UI,Roboto,sans-serif; padding:24px; color:#111; }
          h1{ margin:0 0 6px; font-size:20px; }
          .muted{ color:#555; font-size:13px; margin:0 0 16px; }
          .box{ border:1px solid #ddd; border-radius:12px; padding:14px; margin:14px 0; }
          table{ width:100%; border-collapse:collapse; margin-top:10px; }
          th{ text-align:left; padding:8px; border-bottom:2px solid #ddd; font-size:13px; }
          .right{ text-align:right; }
          .btnRow{ display:flex; gap:10px; margin-top:16px; }
          button{ padding:10px 12px; border-radius:10px; border:1px solid #111; background:#111; color:#fff; cursor:pointer; }
          button.secondary{ background:#fff; color:#111; }
          @media print{
            .btnRow{ display:none; }
            body{ padding:0; }
          }
        </style>
      </head>
      <body>
        <h1>ElectricalFlo 3D — Order Summary</h1>
        <p class="muted">Order Number: <strong>${orderId}</strong></p>

        <div class="box">
          <div><strong>Name:</strong> ${name ? escapeHTML(name) : "—"}</div>
          <div><strong>Payment:</strong> ${escapeHTML(payment)}</div>
          <div><strong>Subtotal:</strong> $${subtotal.toFixed(2)} (before shipping)</div>
        </div>

        <div class="box">
          <strong>Items</strong>
          <table>
            <thead>
              <tr>
                <th>Item</th>
                <th style="text-align:center;">Qty</th>
                <th class="right">Each</th>
                <th class="right">Line</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
          <div style="margin-top:10px;text-align:right;font-weight:700;">
            Subtotal: $${subtotal.toFixed(2)}
          </div>
        </div>

        <div class="box">
          <strong>Notes / customization</strong>
          <div style="white-space:pre-wrap;margin-top:8px;">${notes ? escapeHTML(notes) : "—"}</div>
        </div>

        <div class="box">
          <strong>Shipping address</strong>
          <div style="white-space:pre-wrap;margin-top:8px;">
            ${includeShip && shipAddr ? escapeHTML(shipAddr) : "Will provide after you reply."}
          </div>
        </div>

        <div class="btnRow">
          <button onclick="window.print()">Print</button>
          <button class="secondary" onclick="window.close()">Close</button>
        </div>
      </body>
    </html>
  `);
  w.document.close();

  // ✅ AUTO-RESET after action
  resetOrderId();
}

/* ================= CSV EXPORT ================= */
function downloadCSV(){
  if (!Object.keys(cart).length) return;

  const orderId = getOrCreateOrderId();
  const name = (document.getElementById("customerName")?.value || "").trim();
  const payment = document.getElementById("paymentMethod")?.value || "PayPal";

  const includeShip = document.getElementById("includeShippingNow")?.checked;
  const shipAddr = (document.getElementById("shippingAddress")?.value || "").trim();
  const notes = (document.getElementById("orderNotes")?.value || "").trim();

  const items = buildOrderItems();
  const subtotal = items.reduce((a,b)=>a+b.line,0);

  // CSV rows
  const lines = [];
  lines.push(["OrderNumber", "Name", "Payment", "Subtotal", "Notes", "ShippingAddress"].map(csvEscape).join(","));
  lines.push([orderId, name, payment, subtotal.toFixed(2), notes, includeShip ? shipAddr : ""].map(csvEscape).join(","));
  lines.push("");
  lines.push(["Item", "Qty", "Each", "Line"].map(csvEscape).join(","));
  items.forEach(i => {
    lines.push([i.name, String(i.qty), i.price.toFixed(2), i.line.toFixed(2)].map(csvEscape).join(","));
  });

  const csv = lines.join("\n");
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = `${orderId}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);

  URL.revokeObjectURL(url);

  // ✅ AUTO-RESET after action
  resetOrderId();
}

function csvEscape(v){
  const s = String(v ?? "");
  // wrap if contains comma/quote/newline
  if (/[,"\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
  return s;
}

function escapeHTML(s){
  return String(s ?? "").replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}

/* ================= DRAWER ================= */
function openDrawer(){
  const drawer = document.getElementById("drawer");
  const backdrop = document.getElementById("backdrop");
  drawer.classList.add("open");
  drawer.setAttribute("aria-hidden","false");
  backdrop.hidden = false;
  renderCart();
}

function closeDrawer(){
  const drawer = document.getElementById("drawer");
  const backdrop = document.getElementById("backdrop");
  drawer.classList.remove("open");
  drawer.setAttribute("aria-hidden","true");
  backdrop.hidden = true;
}

/* ================= LIGHTBOX MODAL ================= */
function closeImageModal(){
  const modal = document.querySelector(".imgModal");
  if (modal) modal.remove();
  modalState = null;

  document.documentElement.style.overflow = "";
  document.body.style.overflow = "";

  window.removeEventListener("keydown", onModalKeyDown);
}

function updateModalImage(){
  if (!modalState) return;
  const { imgs, idx, title } = modalState;

  const imgEl = document.getElementById("modalImg");
  const counterEl = document.getElementById("modalCounter");
  if (imgEl) imgEl.src = imgs[idx] || "";
  if (counterEl) counterEl.textContent = `${idx+1} / ${imgs.length}`;

  document.querySelectorAll(".imgModalThumb").forEach(btn => btn.classList.remove("active"));
  const activeBtn = document.querySelector(`.imgModalThumb[data-idx="${idx}"]`);
  if (activeBtn) activeBtn.classList.add("active");

  const titleEl = document.getElementById("modalTitle");
  if (titleEl) titleEl.textContent = title || "Image";
}

function modalPrev(){
  if (!modalState) return;
  modalState.idx = (modalState.idx - 1 + modalState.imgs.length) % modalState.imgs.length;
  updateModalImage();
}

function modalNext(){
  if (!modalState) return;
  modalState.idx = (modalState.idx + 1) % modalState.imgs.length;
  updateModalImage();
}

function onModalKeyDown(e){
  if (!modalState) return;
  if (e.key === "Escape") closeImageModal();
  if (e.key === "ArrowLeft") modalPrev();
  if (e.key === "ArrowRight") modalNext();
}

function openImageModal(productId, startIdx){
  const product = PRODUCTS.find(p => p.id === productId);
  if (!product) return;

  const imgs = getProductImages(product);
  if (!imgs.length) return;

  trackRecent(productId);

  modalState = {
    productId,
    imgs,
    idx: Math.max(0, Math.min(Number(startIdx)||0, imgs.length-1)),
    title: product.name || "Image"
  };

  document.documentElement.style.overflow = "hidden";
  document.body.style.overflow = "hidden";

  const modal = document.createElement("div");
  modal.className = "imgModal";
  modal.innerHTML = `
    <div class="imgModalBackdrop" data-action="closeModal"></div>
    <div class="imgModalPanel" role="dialog" aria-modal="true" aria-label="Image viewer">
      <div class="imgModalHeader">
        <div class="imgModalTitle" id="modalTitle"></div>
        <div style="display:flex;gap:10px;align-items:center;">
          <span id="modalCounter" style="color:var(--muted);font-size:12px;"></span>
          <button class="iconBtn" type="button" data-action="closeModal">✕</button>
        </div>
      </div>

      <div class="imgModalMain" id="modalMain">
        <button class="imgNavBtn" type="button" data-action="prev" aria-label="Previous image">‹</button>
        <img id="modalImg" alt="Product image" />
        <button class="imgNavBtn" type="button" data-action="next" aria-label="Next image">›</button>
      </div>

      <div class="imgModalThumbs">
        ${imgs.map((src, i) => `
          <button class="imgModalThumb ${i===modalState.idx ? "active" : ""}" type="button" data-action="modalThumb" data-idx="${i}" aria-label="View image ${i+1}">
            <img src="${src}" alt="Thumbnail ${i+1}" loading="lazy">
          </button>
        `).join("")}
      </div>
    </div>
  `;

  document.body.appendChild(modal);

  modal.addEventListener("click", (e) => {
    const btn = e.target.closest("[data-action]");
    if (!btn) return;
    const act = btn.getAttribute("data-action");

    if (act === "closeModal") closeImageModal();
    if (act === "prev") modalPrev();
    if (act === "next") modalNext();
    if (act === "modalThumb") {
      modalState.idx = Number(btn.getAttribute("data-idx")) || 0;
      updateModalImage();
    }
  });

  // Swipe support
  const main = document.getElementById("modalMain");
  let sx = 0, sy = 0;
  const THRESH = 50;

  main.addEventListener("touchstart", (e) => {
    const t = e.touches[0];
    sx = t.clientX; sy = t.clientY;
  }, { passive: true });

  main.addEventListener("touchend", (e) => {
    const t = e.changedTouches[0];
    const dx = t.clientX - sx;
    const dy = t.clientY - sy;

    if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > THRESH) {
      if (dx < 0) modalNext();
      else modalPrev();
    }
  }, { passive: true });

  window.addEventListener("keydown", onModalKeyDown);

  updateModalImage();
}

/* ================= GRID EVENT DELEGATION ================= */
function wireGridHandlers(){
  const grid = document.getElementById("grid");
  const recentGrid = document.getElementById("recentGrid");

  function handler(e){
    const el = e.target.closest("[data-action]");
    if (!el) return;

    const action = el.getAttribute("data-action");
    const pid = el.getAttribute("data-pid");

    if (action === "addToCart") { addToCart(pid); return; }

    if (action === "thumb") {
      const idx = Number(el.getAttribute("data-idx")) || 0;
      const product = PRODUCTS.find(p => p.id === pid);
      if (!product) return;

      const imgs = getProductImages(product);
      const imgEl = document.getElementById(`img-${pid}`);
      if (imgEl && imgs[idx]) {
        imgEl.src = imgs[idx];
        imgEl.setAttribute("data-idx", String(idx));
      }

      const strip = el.parentElement;
      strip.querySelectorAll(".thumbBtn").forEach(b => b.classList.remove("active"));
      el.classList.add("active");
      return;
    }

    if (action === "openModal") {
      const idx = Number(el.getAttribute("data-idx")) || 0;
      openImageModal(pid, idx);
      return;
    }
  }

  grid.addEventListener("click", handler);
  recentGrid.addEventListener("click", handler);
}

/* ================= CART EVENT DELEGATION ================= */
function wireCartHandlers(){
  const cartBox = document.getElementById("cartItems");
  cartBox.addEventListener("click", (e) => {
    const el = e.target.closest("[data-action]");
    if (!el) return;
    const action = el.getAttribute("data-action");
    const pid = el.getAttribute("data-pid");

    if (action === "inc") addToCart(pid);
    if (action === "dec") decFromCart(pid);
    if (action === "remove") removeFromCart(pid);
  });
}

/* ================= INIT ================= */
async function init(){
  try{
    const res = await fetch("./products.json", { cache: "no-store" });
    if (!res.ok) throw new Error(`Couldn't load products.json (${res.status})`);
    const txt = await res.text();
    PRODUCTS = JSON.parse(txt);

    if (!Array.isArray(PRODUCTS)) throw new Error("products.json must be an array of products.");

    // UI
    document.getElementById("openCartBtn").addEventListener("click", openDrawer);
    document.getElementById("closeCartBtn").addEventListener("click", closeDrawer);
    document.getElementById("backdrop").addEventListener("click", closeDrawer);

    document.getElementById("emailCheckoutBtn").addEventListener("click", emailCheckout);
    document.getElementById("copyOrderBtn").addEventListener("click", copyOrderDetails);
    document.getElementById("printOrderBtn").addEventListener("click", openPrintSummary);
    document.getElementById("csvOrderBtn").addEventListener("click", downloadCSV);
    document.getElementById("clearCartBtn").addEventListener("click", clearCart);

    document.getElementById("search").addEventListener("input", renderProducts);
    document.getElementById("sort").addEventListener("change", renderProducts);

    document.getElementById("clearRecentBtn").addEventListener("click", clearRecent);

    wireShippingToggle();
    wireGridHandlers();
    wireCartHandlers();

    saveCart();
    renderProducts();
    renderCart();
    renderRecent();
  }catch(err){
    console.error(err);
    const grid = document.getElementById("grid");
    grid.innerHTML = `
      <article class="card">
        <div class="cardBody">
          <h3>Couldn’t load products</h3>
          <p class="empty">${err.message}</p>
          <p class="empty">Check: products.json exists and is valid JSON.</p>
        </div>
      </article>
    `;
  }
}

init();
</script>

</body>
</html>
