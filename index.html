<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ElectricalFlo 3D — Shop</title>
  <link rel="stylesheet" href="/style.css" />
</head>
<body>

<!-- ================= HEADER ================= -->
<header class="header">
  <div class="brandWrap">
    <img src="/images/logo.png" alt="ElectricalFlo Logo" class="logo" />
    <div class="brand">
      <h1>ElectricalFlo</h1>
      <p>3D Printed Gear</p>
    </div>
  </div>

  <button class="cartBtn" id="openCartBtn" type="button">
    Cart <span class="pill" id="cartCount">0</span>
  </button>
</header>

<!-- ================= MAIN ================= -->
<main class="wrap">
  <section class="toolbar">
    <input id="search" placeholder="Search items…" />
  </section>

  <section class="grid" id="grid"></section>
</main>

<!-- ================= CART DRAWER ================= -->
<aside class="drawer" id="drawer" aria-hidden="true">
  <div class="drawerHeader">
    <h2>Your Cart</h2>
    <button class="iconBtn" id="closeCartBtn" type="button">✕</button>
  </div>

  <div class="drawerBody" id="cartItems"></div>

  <div class="drawerFooter">
    <div class="totalRow">
      <span>Subtotal</span>
      <strong id="subtotal">$0.00</strong>
    </div>

    <label class="field">
      <span>Your name (optional)</span>
      <input id="customerName" />
    </label>

    <label class="field">
      <span>Notes (colors, callsign, etc.)</span>
      <textarea id="orderNotes" rows="3"></textarea>
    </label>

    <label class="field">
      <span>Preferred payment method</span>
      <select id="paymentMethod">
        <option>PayPal</option>
        <option>Venmo</option>
        <option>Zelle</option>
      </select>
    </label>

    <button class="primary" id="emailCheckoutBtn" type="button">
      Email Order for Payment Info
    </button>

    <button class="ghost" id="copyOrderBtn" type="button">
      Copy order details
    </button>

    <button class="ghost" id="clearCartBtn" type="button">
      Clear cart
    </button>
  </div>
</aside>

<div class="backdrop" id="backdrop" hidden></div>

<!-- ================= SCRIPT ================= -->
<script>
const EMAIL_TO = "flores@n2cfx.com";
const EMAIL_SUBJECT_PREFIX = "ElectricalFlo Order";

let PRODUCTS = [];
let cart = JSON.parse(localStorage.getItem("cart") || "{}");

const money = n => `$${Number(n || 0).toFixed(2)}`;

function saveCart(){
  localStorage.setItem("cart", JSON.stringify(cart));
  document.getElementById("cartCount").textContent =
    Object.values(cart).reduce((a,b)=>a+b,0);
}

function addToCart(id){
  cart[id] = (cart[id] || 0) + 1;
  saveCart();
  renderCart();
}

function clearCart(){
  cart = {};
  saveCart();
  renderCart();
}

function getImages(p){
  if (Array.isArray(p.images) && p.images.length) return p.images;
  if (p.image) return [p.image];
  return [];
}

/* ================= PRODUCTS ================= */
function renderProducts(){
  const grid = document.getElementById("grid");
  const q = document.getElementById("search").value.trim().toLowerCase();

  const list = PRODUCTS.filter(p=>{
    if (!q) return true;
    const blob = `${p.name||""} ${p.note||""}`.toLowerCase();
    return blob.includes(q);
  });

  if (!list.length){
    grid.innerHTML = `<p class="empty">No products found.</p>`;
    return;
  }

  grid.innerHTML = list.map(p=>{
    const imgs = getImages(p);
    const firstImg = imgs[0] || "";

    return `
      <article class="card">
        <div class="thumb">
          <img src="${firstImg}" alt="${p.name||"Item"}" loading="lazy"
               onclick="openImageModal('${p.id}', 0)">
        </div>

        ${imgs.length > 1 ? `
          <div class="thumbStrip">
            ${imgs.map((img,i)=>`
              <button class="thumbBtn" onclick="openImageModal('${p.id}', ${i})">
                <img src="${img}" alt="">
              </button>
            `).join("")}
          </div>
        ` : ""}

        <div class="cardBody">
          <h3>${p.name||"Untitled item"}</h3>
          <div class="meta">
            <span class="price">${money(p.price)}</span>
            <span class="note">${p.note||""}</span>
          </div>
          <button class="primary" type="button" onclick="addToCart('${p.id}')">
            Add to cart
          </button>
        </div>
      </article>
    `;
  }).join("");
}

/* ================= CART ================= */
function renderCart(){
  const box = document.getElementById("cartItems");
  const items = Object.entries(cart).map(([id,qty])=>{
    const p = PRODUCTS.find(x=>x.id===id);
    if (!p) return null;
    return {p,qty,line:Number(p.price||0)*Number(qty||0)};
  }).filter(Boolean);

  if (!items.length){
    box.innerHTML = `<p class="empty">Your cart is empty.</p>`;
    document.getElementById("subtotal").textContent = money(0);
    return;
  }

  box.innerHTML = items.map(i=>`
    <div class="cartRow">
      <strong>${i.p.name}</strong> × ${i.qty}
      <div class="muted">${money(i.p.price)} each • Line: ${money(i.line)}</div>
    </div>
  `).join("");

  document.getElementById("subtotal").textContent =
    money(items.reduce((a,b)=>a+b.line,0));
}

/* ================= EMAIL ================= */
function buildEmailBody(){
  const name = document.getElementById("customerName").value.trim();
  const notes = document.getElementById("orderNotes").value.trim();
  const payment = document.getElementById("paymentMethod").value;

  const lines = [];
  lines.push("Hi! I'd like to place an order:");
  lines.push("");
  if (name) lines.push(`Name: ${name}`);
  lines.push(`Preferred payment method: ${payment}`);
  lines.push("");
  lines.push("Items:");

  let subtotal = 0;
  Object.entries(cart).forEach(([id,qty])=>{
    const p = PRODUCTS.find(x=>x.id===id);
    if (!p) return;
    const total = Number(p.price||0)*Number(qty||0);
    subtotal += total;
    lines.push(`- ${p.name} (x${qty}) — ${money(total)}`);
  });

  lines.push("");
  lines.push(`Subtotal (before shipping): ${money(subtotal)}`);
  if (notes){
    lines.push("");
    lines.push("Notes:");
    lines.push(notes);
  }

  lines.push("");
  lines.push("Please reply with payment and shipping info. Thanks!");
  return lines.join("\n");
}

function emailCheckout(){
  if (!Object.keys(cart).length) return;
  const subject = encodeURIComponent(EMAIL_SUBJECT_PREFIX);
  const body = encodeURIComponent(buildEmailBody());
  window.location.href = `mailto:${EMAIL_TO}?subject=${subject}&body=${body}`;
}

async function copyOrderDetails(){
  if (!Object.keys(cart).length) return;
  const text = buildEmailBody();
  await navigator.clipboard.writeText(text);
  alert("Copied! Paste into an email or message.");
}

/* ================= MODAL ================= */
function openImageModal(productId, index){
  const p = PRODUCTS.find(x=>x.id===productId);
  if (!p) return;

  const imgs = getImages(p);
  let current = index;

  const modal = document.createElement("div");
  modal.className = "imgModal";
  modal.innerHTML = `
    <div class="imgModalBackdrop" onclick="this.parentNode.remove()"></div>
    <div class="imgModalPanel">
      <div class="imgModalHeader">
        <span>${p.name}</span>
        <button class="iconBtn" onclick="this.closest('.imgModal').remove()">✕</button>
      </div>
      <div class="imgModalMain">
        <img src="${imgs[current]}" id="modalImg">
      </div>
      <div class="imgModalThumbs">
        ${imgs.map((img,i)=>`
          <button class="imgModalThumb ${i===current?'active':''}"
                  onclick="document.getElementById('modalImg').src='${img}'">
            <img src="${img}">
          </button>
        `).join("")}
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

/* ================= INIT ================= */
async function init(){
  PRODUCTS = await (await fetch("/products.json",{cache:"no-store"})).json();

  document.getElementById("search").addEventListener("input", renderProducts);
  document.getElementById("openCartBtn").onclick = ()=>{drawer.classList.add("open");backdrop.hidden=false;renderCart();};
  document.getElementById("closeCartBtn").onclick = ()=>{drawer.classList.remove("open");backdrop.hidden=true;};
  document.getElementById("backdrop").onclick = ()=>{drawer.classList.remove("open");backdrop.hidden=true;};
  document.getElementById("emailCheckoutBtn").onclick = emailCheckout;
  document.getElementById("copyOrderBtn").onclick = copyOrderDetails;
  document.getElementById("clearCartBtn").onclick = clearCart;

  saveCart();
  renderProducts();
  renderCart();
}

init();
</script>
</body>
</html>
