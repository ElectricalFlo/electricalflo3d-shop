<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ElectricalFlo 3D — Shop</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<!-- DEBUG (remove later) -->
<div id="debugBox" style="padding:10px 18px;border-bottom:1px solid #232a36;background:#151a22;color:#e6e6e6;font-size:13px;">
  Loading…
</div>

<header class="header">
  <div class="brandWrap">
    <img src="images/logo.png" alt="ElectricalFlo 3D Logo" class="logo" />
    <div class="brand">
      <h1>ElectricalFlo 3D</h1>
      <p>3D printed gear • custom orders welcome</p>
    </div>
  </div>

  <button class="cartBtn" id="openCartBtn" type="button">
    Cart <span class="pill" id="cartCount">0</span>
  </button>
</header>

<main class="wrap">
  <section class="toolbar">
    <input id="search" placeholder="Search items…" />
    <select id="sort">
      <option value="featured">Sort: Featured</option>
      <option value="price_asc">Price: Low → High</option>
      <option value="price_desc">Price: High → Low</option>
      <option value="name_asc">Name: A → Z</option>
    </select>
  </section>

  <section class="grid" id="grid"></section>
</main>

<aside class="drawer" id="drawer" aria-hidden="true">
  <div class="drawerHeader">
    <h2>Your Cart</h2>
    <button class="iconBtn" id="closeCartBtn" type="button">✕</button>
  </div>

  <div class="drawerBody" id="cartItems"></div>

  <div class="drawerFooter">
    <div class="totalRow">
      <span>Subtotal</span>
      <strong id="subtotal">$0.00</strong>
    </div>

    <label class="field">
      <span>Your name (optional)</span>
      <input id="customerName" />
    </label>

    <label class="field">
      <span>Notes (colors, callsign, etc.)</span>
      <textarea id="orderNotes" rows="3"></textarea>
    </label>

    <label class="field">
      <span>Preferred payment method</span>
      <select id="paymentMethod">
        <option value="PayPal">PayPal</option>
        <option value="Venmo">Venmo</option>
        <option value="Zelle">Zelle</option>
      </select>
    </label>

    <label class="field checkbox">
      <input type="checkbox" id="includeShippingNow" />
      <span>Include shipping address now (optional)</span>
    </label>

    <label class="field" id="shippingWrap" style="display:none">
      <span>Shipping address</span>
      <textarea id="shippingAddress" rows="3"></textarea>
    </label>

    <button class="primary" id="emailCheckoutBtn" type="button">
      Email Order for Payment Info
    </button>

    <button class="ghost" id="copyOrderBtn" type="button">
      Copy order details
    </button>

    <button class="ghost" id="clearCartBtn" type="button">
      Clear cart
    </button>
  </div>
</aside>

<div class="backdrop" id="backdrop" hidden></div>

<script>
const EMAIL_TO = "flores@n2cfx.com";
const EMAIL_SUBJECT_PREFIX = "ElectricalFlo 3D Order";

let PRODUCTS = [];
let cart = JSON.parse(localStorage.getItem("cart") || "{}");

const money = n => `$${Number(n).toFixed(2)}`;

function setDebug(msg){
  const el = document.getElementById("debugBox");
  if (el) el.textContent = msg;
}

function wireShippingToggle(){
  const cb = document.getElementById("includeShippingNow");
  const wrap = document.getElementById("shippingWrap");
  if (!cb || !wrap) return;
  cb.addEventListener("change", () => {
    wrap.style.display = cb.checked ? "block" : "none";
  });
}

function saveCart(){
  localStorage.setItem("cart", JSON.stringify(cart));
  document.getElementById("cartCount").textContent =
    Object.values(cart).reduce((a,b)=>a+b,0);
}

function addToCart(id){
  cart[id] = (cart[id] || 0) + 1;
  saveCart();
  renderCart();
}

function clearCart(){
  cart = {};
  saveCart();
  renderCart();
}

function getProductImages(p){
  if (Array.isArray(p.images) && p.images.length) return p.images;
  if (p.image) return [p.image];
  return [];
}

function renderProducts(){
  const grid = document.getElementById("grid");

  if (!PRODUCTS.length){
    grid.innerHTML = `<p class="empty">No products found in products.json.</p>`;
    return;
  }

  grid.innerHTML = PRODUCTS.map(p => {
    const imgs = getProductImages(p);
    const firstImg = imgs[0] || "";

    return `
      <article class="card">
        <div class="thumb">
          <img
            src="${firstImg}"
            alt="${p.name || "Item"}"
            id="img-${p.id}"
            loading="lazy"
            onerror="this.style.display='none'"
          >
        </div>

        ${imgs.length > 1 ? `
          <div class="thumbDots">
            ${imgs.map((_, i) => `
              <button class="dot" type="button"
                onclick="swapImg('${p.id}', ${i})"
                aria-label="View image ${i+1}">
              </button>
            `).join("")}
          </div>
        ` : ""}

        <div class="cardBody">
          <h3>${p.name || "Untitled item"}</h3>
          <span class="price">${money(p.price || 0)}</span>
          <button class="primary" type="button" onclick="addToCart('${p.id}')">Add to cart</button>
        </div>
      </article>
    `;
  }).join("");
}

function swapImg(productId, imgIndex){
  const product = PRODUCTS.find(p => p.id === productId);
  if (!product) return;

  const imgs = getProductImages(product);
  const imgEl = document.getElementById(`img-${productId}`);
  if (imgEl && imgs[imgIndex]) imgEl.src = imgs[imgIndex];
}

function renderCart(){
  const box = document.getElementById("cartItems");
  const items = Object.entries(cart).map(([id,qty])=>{
    const p = PRODUCTS.find(x=>x.id===id);
    if(!p) return null;
    return {p,qty,line:Number(p.price)*Number(qty)};
  }).filter(Boolean);

  if(!items.length){
    box.innerHTML = "<p class='empty'>Your cart is empty.</p>";
    document.getElementById("subtotal").textContent = money(0);
    return;
  }

  box.innerHTML = items.map(i=>`
    <div class="cartRow">
      <strong>${i.p.name}</strong> × ${i.qty}
      <div class="muted">${money(i.p.price)} each • Line: ${money(i.line)}</div>
    </div>
  `).join("");

  document.getElementById("subtotal").textContent =
    money(items.reduce((a,b)=>a+b.line,0));
}

function buildEmailBody(){
  const name = (document.getElementById("customerName")?.value || "").trim();
  const notes = (document.getElementById("orderNotes")?.value || "").trim();
  const payment = document.getElementById("paymentMethod")?.value || "PayPal";

  const includeShip = document.getElementById("includeShippingNow")?.checked;
  const shipAddr = (document.getElementById("shippingAddress")?.value || "").trim();

  const items = Object.entries(cart).map(([id, qty]) => {
    const p = PRODUCTS.find(x => x.id === id);
    if (!p) return null;
    const line = Number(p.price) * Number(qty);
    return { name: p.name, qty: Number(qty), line };
  }).filter(Boolean);

  const subtotal = items.reduce((a,b) => a + b.line, 0);

  const lines = [];
  lines.push("Hi! I'd like to place an order:");
  lines.push("");

  if (name) lines.push(`Name: ${name}`);
  lines.push(`Preferred payment method: ${payment}`);
  lines.push("");

  lines.push("Items:");
  items.forEach(i => lines.push(`- ${i.name} (x${i.qty}) — $${i.line.toFixed(2)}`));

  lines.push("");
  lines.push(`Subtotal (before shipping): $${subtotal.toFixed(2)}`);
  lines.push("");

  if (notes) {
    lines.push("Notes / customization:");
    lines.push(notes);
    lines.push("");
  }

  if (includeShip && shipAddr) {
    lines.push("Shipping address:");
    lines.push(shipAddr);
    lines.push("");
  } else {
    lines.push("Shipping address: I can provide after you reply.");
    lines.push("");
  }

  lines.push("Please reply with the total (including shipping) and your payment details for the method I selected. Thanks!");
  return lines.join("\n");
}

function emailCheckout(){
  if(!Object.keys(cart).length) return;

  const itemCount = Object.values(cart).reduce((a,b)=>a+b,0);
  const subject = encodeURIComponent(`${EMAIL_SUBJECT_PREFIX} (${itemCount} item${itemCount===1?"":"s"})`);
  const body = encodeURIComponent(buildEmailBody());

  window.location.href = `mailto:${encodeURIComponent(EMAIL_TO)}?subject=${subject}&body=${body}`;
}

async function copyOrderDetails(){
  if(!Object.keys(cart).length) return;

  const text = buildEmailBody();
  try{
    await navigator.clipboard.writeText(text);
    alert("Copied! Paste it into an email/text to send your order.");
  }catch{
    const ta = document.createElement("textarea");
    ta.value = text;
    ta.style.position = "absolute";
    ta.style.left = "-9999px";
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    document.body.removeChild(ta);
    alert("Copied! Paste it into an email/text to send your order.");
  }
}

function openDrawer(){
  document.getElementById("drawer").classList.add("open");
  document.getElementById("drawer").setAttribute("aria-hidden","false");
  document.getElementById("backdrop").hidden = false;
  renderCart();
}

function closeDrawer(){
  document.getElementById("drawer").classList.remove("open");
  document.getElementById("drawer").setAttribute("aria-hidden","true");
  document.getElementById("backdrop").hidden = true;
}

async function init(){
  setDebug("Fetching products.json…");

  try {
    const res = await fetch("./products.json", { cache: "no-store" });
    setDebug(`products.json HTTP status: ${res.status}`);

    if (!res.ok) throw new Error(`Fetch failed: ${res.status} ${res.statusText}`);

    const txt = await res.text();
    // Show first bit of text so we know we're actually getting JSON
    setDebug(`products.json loaded (${txt.length} chars). Parsing…`);

    PRODUCTS = JSON.parse(txt);

    if (!Array.isArray(PRODUCTS)) throw new Error("products.json must be an array");

    setDebug(`OK ✅ Loaded ${PRODUCTS.length} product(s). Rendering…`);

    document.getElementById("openCartBtn").onclick = openDrawer;
    document.getElementById("closeCartBtn").onclick = closeDrawer;
    document.getElementById("backdrop").onclick = closeDrawer;
    document.getElementById("emailCheckoutBtn").onclick = emailCheckout;
    document.getElementById("copyOrderBtn").onclick = copyOrderDetails;
    document.getElementById("clearCartBtn").onclick = clearCart;

    wireShippingToggle();
    saveCart();
    renderProducts();
    renderCart();
  } catch (err) {
    console.error(err);
    setDebug(`ERROR ❌ ${err.message}`);

    const grid = document.getElementById("grid");
    grid.innerHTML = `
      <article class="card">
        <div class="cardBody">
          <h3>Couldn’t load products</h3>
          <p class="empty">${err.message}</p>
          <p class="empty">Try opening: /products.json</p>
        </div>
      </article>
    `;
  }
}

init();
</script>

</body>
</html>
