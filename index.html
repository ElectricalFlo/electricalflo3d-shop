<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ElectricalFlo 3D — Shop</title>
 <link rel="stylesheet" href="style.css?v=20260130-2" />

</head>
<body>

<header class="header">
  <div class="brandWrap">
    <img src="images/logo.png" alt="ElectricalFlo 3D Logo" class="logo" />
    <div class="brand">
      <h1>ElectricalFlo 3D</h1>
      <p>3D printed gear • custom orders welcome</p>
    </div>
  </div>

  <button class="cartBtn" id="openCartBtn" type="button">
    Cart <span class="pill" id="cartCount">0</span>
  </button>
</header>

<main class="wrap">
  <section class="toolbar">
    <input id="search" placeholder="Search items…" />
    <select id="sort">
      <option value="featured">Sort: Featured</option>
      <option value="price_asc">Price: Low → High</option>
      <option value="price_desc">Price: High → Low</option>
      <option value="name_asc">Name: A → Z</option>
    </select>
  </section>

  <section class="grid" id="grid"></section>
</main>

<!-- ================= CART DRAWER ================= -->
<aside class="drawer" id="drawer" aria-hidden="true">
  <div class="drawerHeader">
    <h2>Your Cart</h2>
    <button class="iconBtn" id="closeCartBtn" type="button">✕</button>
  </div>

  <div class="drawerBody" id="cartItems"></div>

  <div class="drawerFooter">
    <div class="totalRow">
      <span>Subtotal</span>
      <strong id="subtotal">$0.00</strong>
    </div>

    <label class="field">
      <span>Your name (optional)</span>
      <input id="customerName" />
    </label>

    <label class="field">
      <span>Notes (colors, callsign, etc.)</span>
      <textarea id="orderNotes" rows="3"></textarea>
    </label>

    <label class="field">
      <span>Preferred payment method</span>
      <select id="paymentMethod">
        <option value="PayPal">PayPal</option>
        <option value="Venmo">Venmo</option>
        <option value="Zelle">Zelle</option>
      </select>
    </label>

    <label class="field checkbox">
      <input type="checkbox" id="includeShippingNow" />
      <span>Include shipping address now (optional)</span>
    </label>

    <label class="field" id="shippingWrap" style="display:none">
      <span>Shipping address</span>
      <textarea id="shippingAddress" rows="3"></textarea>
    </label>

    <button class="primary" id="emailCheckoutBtn" type="button">
      Email Order for Payment Info
    </button>

    <button class="ghost" id="copyOrderBtn" type="button">
      Copy order details
    </button>

    <button class="ghost" id="clearCartBtn" type="button">
      Clear cart
    </button>
  </div>
</aside>

<div class="backdrop" id="backdrop" hidden></div>

<!-- ================= FULLSCREEN VIEWER MODAL ================= -->
<div class="imgModal" id="imgModal" hidden aria-hidden="true">
  <div class="imgModalBackdrop" id="imgModalBackdrop"></div>

  <div class="imgModalPanel" role="dialog" aria-modal="true">
    <div class="imgModalHeader">
      <div class="imgModalTitle" id="imgModalTitle">Item</div>
      <button class="iconBtn" id="imgModalCloseBtn" type="button">✕</button>
    </div>

    <div class="imgModalMain">
      <button class="imgNavBtn" id="imgPrevBtn" type="button" aria-label="Previous image">‹</button>
      <img id="imgModalMainImg" alt="Product image" />
      <button class="imgNavBtn" id="imgNextBtn" type="button" aria-label="Next image">›</button>
    </div>

    <div class="imgModalThumbs" id="imgModalThumbs"></div>
  </div>
</div>

<script>
const EMAIL_TO = "flores@n2cfx.com";
const EMAIL_SUBJECT_PREFIX = "ElectricalFlo 3D Order";

let PRODUCTS = [];
let cart = JSON.parse(localStorage.getItem("cart") || "{}");

// For per-product selected thumbnail on the product cards:
let selectedImageIndex = JSON.parse(localStorage.getItem("selectedImageIndex") || "{}"); // { productId: idx }

// For fullscreen viewer state:
let viewerProductId = null;
let viewerIndex = 0;

const money = n => `$${Number(n).toFixed(2)}`;

// ---------- Order Number ----------
function generateOrderNumber(){
  // Example: EF-20260130-7K2P
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  const rand = Math.random().toString(36).toUpperCase().slice(2,6);
  return `EF-${y}${m}${day}-${rand}`;
}

function getOrderNumber(){
  let orderNo = localStorage.getItem("currentOrderNo");
  if (!orderNo) {
    orderNo = generateOrderNumber();
    localStorage.setItem("currentOrderNo", orderNo);
  }
  return orderNo;
}

function clearOrderNumber(){
  localStorage.removeItem("currentOrderNo");
}

// ---------- UI helpers ----------
function wireShippingToggle(){
  const cb = document.getElementById("includeShippingNow");
  const wrap = document.getElementById("shippingWrap");
  if (!cb || !wrap) return;
  cb.addEventListener("change", () => {
    wrap.style.display = cb.checked ? "block" : "none";
  });
}

function saveSelectedImageIndex(){
  localStorage.setItem("selectedImageIndex", JSON.stringify(selectedImageIndex));
}

function saveCart(){
  localStorage.setItem("cart", JSON.stringify(cart));
  document.getElementById("cartCount").textContent =
    Object.values(cart).reduce((a,b)=>a+b,0);
}

function addToCart(id){
  cart[id] = (cart[id] || 0) + 1;
  saveCart();
  renderCart();
}

function clearCart(){
  cart = {};
  saveCart();
  renderCart();
  clearOrderNumber(); // new order number next time
}

function getProductImages(p){
  if (Array.isArray(p.images) && p.images.length) return p.images;
  if (p.image) return [p.image];
  return [];
}

function getFilteredSortedProducts() {
  const q = document.getElementById("search").value.trim().toLowerCase();
  const sort = document.getElementById("sort").value;

  let list = PRODUCTS.filter(p =>
    !q || (p.name + " " + (p.note||"")).toLowerCase().includes(q)
  );

  if (sort === "price_asc") list.sort((a,b) => a.price - b.price);
  if (sort === "price_desc") list.sort((a,b) => b.price - a.price);
  if (sort === "name_asc") list.sort((a,b) => a.name.localeCompare(b.name));
  return list;
}

// ---------- Product rendering with thumbnails ----------
function setCardImage(productId, idx){
  selectedImageIndex[productId] = idx;
  saveSelectedImageIndex();

  const imgEl = document.getElementById(`img-${productId}`);
  const p = PRODUCTS.find(x => x.id === productId);
  if (!imgEl || !p) return;

  const imgs = getProductImages(p);
  if (imgs[idx]) imgEl.src = imgs[idx];

  // Highlight selected thumbnail
  const wrap = document.getElementById(`thumbs-${productId}`);
  if (!wrap) return;
  [...wrap.querySelectorAll("button")].forEach((btn, i) => {
    btn.classList.toggle("active", i === idx);
  });
}

function openViewer(productId, idx){
  const p = PRODUCTS.find(x => x.id === productId);
  if (!p) return;

  const imgs = getProductImages(p);
  if (!imgs.length) return;

  viewerProductId = productId;
  viewerIndex = Math.max(0, Math.min(idx, imgs.length - 1));

  const modal = document.getElementById("imgModal");
  const mainImg = document.getElementById("imgModalMainImg");
  const title = document.getElementById("imgModalTitle");
  const thumbs = document.getElementById("imgModalThumbs");

  title.textContent = p.name || "Item";
  mainImg.src = imgs[viewerIndex];

  thumbs.innerHTML = imgs.map((src, i) => `
    <button class="imgModalThumb ${i===viewerIndex ? "active" : ""}" type="button" aria-label="View image ${i+1}">
      <img src="${src}" alt="">
    </button>
  `).join("");

  // Bind thumb clicks
  [...thumbs.querySelectorAll("button")].forEach((btn, i) => {
    btn.addEventListener("click", () => setViewerIndex(i));
  });

  modal.hidden = false;
  modal.setAttribute("aria-hidden","false");
  document.body.style.overflow = "hidden";
}

function closeViewer(){
  const modal = document.getElementById("imgModal");
  modal.hidden = true;
  modal.setAttribute("aria-hidden","true");
  document.body.style.overflow = "";
  viewerProductId = null;
  viewerIndex = 0;
}

function setViewerIndex(i){
  const p = PRODUCTS.find(x => x.id === viewerProductId);
  if (!p) return;
  const imgs = getProductImages(p);
  if (!imgs.length) return;

  viewerIndex = (i + imgs.length) % imgs.length;

  document.getElementById("imgModalMainImg").src = imgs[viewerIndex];

  const thumbs = document.getElementById("imgModalThumbs");
  [...thumbs.querySelectorAll("button")].forEach((btn, idx) => {
    btn.classList.toggle("active", idx === viewerIndex);
  });
}

function viewerPrev(){
  setViewerIndex(viewerIndex - 1);
}
function viewerNext(){
  setViewerIndex(viewerIndex + 1);
}

function renderProducts(){
  const grid = document.getElementById("grid");
  const list = getFilteredSortedProducts();

  if (!list.length){
    grid.innerHTML = `<p class="empty">No products found.</p>`;
    return;
  }

  grid.innerHTML = list.map(p => {
    const imgs = getProductImages(p);
    const idx = Number(selectedImageIndex[p.id] ?? 0);
    const safeIdx = Math.max(0, Math.min(idx, imgs.length ? imgs.length - 1 : 0));
    const mainSrc = imgs[safeIdx] || "";

    return `
      <article class="card">
        <div class="thumb">
          <img
            class="thumbMainImg"
            src="${mainSrc}"
            alt="${p.name || "Item"}"
            id="img-${p.id}"
            loading="lazy"
            onerror="this.style.display='none'"
          >
        </div>

        ${imgs.length > 1 ? `
          <div class="thumbStrip" id="thumbs-${p.id}">
            ${imgs.map((src, i) => `
              <button class="thumbBtn ${i===safeIdx ? "active" : ""}" type="button" aria-label="Select image ${i+1}">
                <img src="${src}" alt="">
              </button>
            `).join("")}
          </div>
        ` : ""}

        <div class="cardBody">
          <h3>${p.name || "Untitled item"}</h3>
          <div class="meta">
            <span class="price">${money(p.price || 0)}</span>
            <span class="note">${p.note || ""}</span>
          </div>
          <button class="primary" type="button" onclick="addToCart('${p.id}')">Add to cart</button>
        </div>
      </article>
    `;
  }).join("");

  // Wire thumbnail clicks + fullscreen click
  list.forEach(p => {
    const imgs = getProductImages(p);
    const imgEl = document.getElementById(`img-${p.id}`);

    if (imgEl && imgs.length) {
      imgEl.style.cursor = imgs.length > 1 ? "zoom-in" : "zoom-in";
      imgEl.addEventListener("click", () => {
        const idx = Number(selectedImageIndex[p.id] ?? 0);
        openViewer(p.id, idx);
      });
    }

    const strip = document.getElementById(`thumbs-${p.id}`);
    if (strip) {
      [...strip.querySelectorAll("button")].forEach((btn, i) => {
        btn.addEventListener("click", () => setCardImage(p.id, i));
      });
    }
  });
}

// ---------- Cart ----------
function renderCart(){
  const box = document.getElementById("cartItems");
  const items = Object.entries(cart).map(([id,qty])=>{
    const p = PRODUCTS.find(x=>x.id===id);
    if(!p) return null;
    return {p,qty,line:Number(p.price)*Number(qty)};
  }).filter(Boolean);

  if(!items.length){
    box.innerHTML = "<p class='empty'>Your cart is empty.</p>";
    document.getElementById("subtotal").textContent = money(0);
    return;
  }

  box.innerHTML = items.map(i=>`
    <div class="cartRow">
      <strong>${i.p.name}</strong> × ${i.qty}
      <div class="muted">${money(i.p.price)} each • Line: ${money(i.line)}</div>
    </div>
  `).join("");

  document.getElementById("subtotal").textContent =
    money(items.reduce((a,b)=>a+b.line,0));
}

// ---------- Checkout (with order number) ----------
function buildEmailBody(){
  const orderNo = getOrderNumber();
  const name = (document.getElementById("customerName")?.value || "").trim();
  const notes = (document.getElementById("orderNotes")?.value || "").trim();
  const payment = document.getElementById("paymentMethod")?.value || "PayPal";

  const includeShip = document.getElementById("includeShippingNow")?.checked;
  const shipAddr = (document.getElementById("shippingAddress")?.value || "").trim();

  const items = Object.entries(cart).map(([id, qty]) => {
    const p = PRODUCTS.find(x => x.id === id);
    if (!p) return null;
    const line = Number(p.price) * Number(qty);
    return { name: p.name, qty: Number(qty), line };
  }).filter(Boolean);

  const subtotal = items.reduce((a,b) => a + b.line, 0);

  const lines = [];
  lines.push(`Order #: ${orderNo}`);
  lines.push("");
  lines.push("Hi! I'd like to place an order:");
  lines.push("");

  if (name) lines.push(`Name: ${name}`);
  lines.push(`Preferred payment method: ${payment}`);
  lines.push("");

  lines.push("Items:");
  items.forEach(i => lines.push(`- ${i.name} (x${i.qty}) — $${i.line.toFixed(2)}`));

  lines.push("");
  lines.push(`Subtotal (before shipping): $${subtotal.toFixed(2)}`);
  lines.push("");

  if (notes) {
    lines.push("Notes / customization:");
    lines.push(notes);
    lines.push("");
  }

  if (includeShip && shipAddr) {
    lines.push("Shipping address:");
    lines.push(shipAddr);
    lines.push("");
  } else {
    lines.push("Shipping address: I can provide after you reply.");
    lines.push("");
  }

  lines.push("Please reply with the total (including shipping) and your payment details for the method I selected. Thanks!");
  return lines.join("\n");
}

function emailCheckout(){
  if(!Object.keys(cart).length) return;

  const orderNo = getOrderNumber();
  const itemCount = Object.values(cart).reduce((a,b)=>a+b,0);

  const subject = encodeURIComponent(`${EMAIL_SUBJECT_PREFIX} #${orderNo} (${itemCount} item${itemCount===1?"":"s"})`);
  const body = encodeURIComponent(buildEmailBody());

  window.location.href = `mailto:${encodeURIComponent(EMAIL_TO)}?subject=${subject}&body=${body}`;
}

async function copyOrderDetails(){
  if(!Object.keys(cart).length) return;
  const text = buildEmailBody();

  try{
    await navigator.clipboard.writeText(text);
    alert("Copied! Paste it into an email/text to send your order.");
  }catch{
    const ta = document.createElement("textarea");
    ta.value = text;
    ta.style.position = "absolute";
    ta.style.left = "-9999px";
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    document.body.removeChild(ta);
    alert("Copied! Paste it into an email/text to send your order.");
  }
}

// ---------- Drawer ----------
function openDrawer(){
  document.getElementById("drawer").classList.add("open");
  document.getElementById("drawer").setAttribute("aria-hidden","false");
  document.getElementById("backdrop").hidden = false;
  renderCart();
}

function closeDrawer(){
  document.getElementById("drawer").classList.remove("open");
  document.getElementById("drawer").setAttribute("aria-hidden","true");
  document.getElementById("backdrop").hidden = true;
}

// ---------- Init ----------
async function init(){
  const res = await fetch("./products.json", { cache: "no-store" });
  if (!res.ok) throw new Error(`products.json fetch failed: ${res.status}`);

  PRODUCTS = await res.json();

  document.getElementById("search").addEventListener("input", renderProducts);
  document.getElementById("sort").addEventListener("change", renderProducts);

  document.getElementById("openCartBtn").onclick = openDrawer;
  document.getElementById("closeCartBtn").onclick = closeDrawer;
  document.getElementById("backdrop").onclick = closeDrawer;

  document.getElementById("emailCheckoutBtn").onclick = emailCheckout;
  document.getElementById("copyOrderBtn").onclick = copyOrderDetails;
  document.getElementById("clearCartBtn").onclick = clearCart;

  wireShippingToggle();
  saveCart();
  renderProducts();
  renderCart();

  // Modal wiring
  document.getElementById("imgModalCloseBtn").addEventListener("click", closeViewer);
  document.getElementById("imgModalBackdrop").addEventListener("click", closeViewer);
  document.getElementById("imgPrevBtn").addEventListener("click", viewerPrev);
  document.getElementById("imgNextBtn").addEventListener("click", viewerNext);

  document.addEventListener("keydown", (e) => {
    const modal = document.getElementById("imgModal");
    if (modal.hidden) return;

    if (e.key === "Escape") closeViewer();
    if (e.key === "ArrowLeft") viewerPrev();
    if (e.key === "ArrowRight") viewerNext();
  });
}

init().catch(err => {
  console.error(err);
  const grid = document.getElementById("grid");
  grid.innerHTML = `
    <article class="card">
      <div class="cardBody">
        <h3>Couldn’t load products</h3>
        <p class="empty">${err.message}</p>
        <p class="empty">Try opening: /products.json</p>
      </div>
    </article>
  `;
});
</script>

</body>
</html>
